<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>
   <!--bootstrap-->
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!--fontawsom-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&family=Tajawal:wght@500;700&display=swap" rel="stylesheet">
 <!--css-->
    <link rel="stylesheet" href="admin.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
    

    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .add-btn {
      padding: 8px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }


    input, select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      margin: 5px;
    }
     

    table{
        border-radius: 5px;
        overflow: hidden;
    }
    

   

    .data-table th {
      background-color: #34495e;
      color: white;
    }

   

    .action-btn {
      padding: 5px 7px;
      margin: 1px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
      font-size: 16px;
    }

    .edit { background-color: #2980b9; }
    .delete { background-color: #c0392b; }
    .disable { background-color: #f39c12; }
  </style>
    </head>
    <body>
     
       <!-- Sidebar -->
        
      <div class="sidebar">
        <div class="title">
          <h1><span>لوحة التحكم</span></h1>
        </div>
       <ul>
         <li>
            <a href="admin.html">
            <i class="fa-solid fa-house"></i>
            <span>الصفحة الرئيسية</span>
            </a>
          </li>
          <li>
            <a href="orderManagement.html">
            <i class="fa-solid fa-list-check"></i>
            <span>إدارة الطلبات</span>
          </a>
          </li>
          <li>
            <a href="donations.html">
            <i class="fa-solid fa-dollar-sign"></i>
            <span>التبرعات</span>
            </a>
          </li>
          <li>
            <a href="users.html">
            <i class="fa-solid fa-users"></i>
            <span>المستخدمون</span>
            </a>
          </li>

          
          <li>
            <a href="reports.html">
            <i class="fas fa-chart-line"></i>
            <span>التقارير</span>
            </a>
          </li>
         

          
          <li>
            <a href="settings.html">
            <i class="fas fa-cog"></i>
            <span>الإعدادات</span>
            </a>
          </li>

          <li>
            <a href="HomePage.html">
           <i class="fa-solid fa-arrow-up-right-from-square"></i>
            <span>زيارة الموقع</span>
            </a>
          </li>
          
         <li class="log-out " id="logoutBtn">
            <a href="#">
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
            <span>تسجيل الخروج</span>
            </a>
          </li>
        </div>
      </div>
       <!--end Sidebar--> 

       <div class="page">

        <!-- Header -->
       <div class="header">
        <div class="header-info">
        <div>
           مرحبا بك، <span id="header-welcome-name">محمد</span>! 
        </div>
        <div class="header-actions">
         <!-- أيقونة الجرس -->
    <div class="notification-dropdown">
          <div class="notification" id="notification">
            <i class="fa-solid fa-bell" id="storyBell"></i>
               <span class="badge" id="storyCount">0</span>
                 </div>
                 
     <ul class="menu" id="pendingList">
      
      <li> لا توجد إشعارات</li>
      
     </ul>
     
</div>
         
          <div class="user-profile">
            <div class="profile-img">
              <img src="" alt="profile-img"  id="header-profile-pic">
            </div>
            <div class="user-info">
              <div class="user-name"  id="header-user-name"></div>
              <div class="user-role">مدير النظام</div>
            </div>
          </div>
        </div>
        </div>
        </div>
       <!--end header-->

       <div class="content">
        <div class="page-title">
            <div class="text">إدارة المستخدمين</div>
        </div>
       

  <div class="controls ">
  
    <input type="text" id="searchInput" class="w-75" placeholder="ابحث بالاسم أو البريد">
    <select id="roleFilter" class="form-select " style="width: 170px;">
      <option value="">جميع المستخدمين</option>
      <option value="متبرع">متبرع</option>
      <option value="محتاج">محتاج</option>
      <option value="أدمن">أدمن</option>
    </select>
   
  </div>
 <div class="table-responsive">
  <table id="usersTable" class="data-table bg-white">
    <thead>
      <tr>
        <th>رقم المستخدم</th>
        <th>الاسم الكامل</th>
        <th>البريد الإلكتروني</th>
        <th>نوع الحساب</th>
        <th>الحالة</th>
        <th>الإجراءات</th>
      </tr>
    </thead>
    <tbody>
     
    </tbody>
  </table>
  </div>
  <div id="pagination" class="pagination justify-content-center"></div>

</div>
</div>


<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-between">
        <div>
        <h5 class="modal-title">تعديل بيانات المستخدم</h5>
        </div>
       <div> 
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      </div>
      <div class="modal-body">
        <form id="editForm">

          <div class="mb-3">
            <label class="form-label">الاسم الكامل</label>
            <input type="text" id="editName" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" id="editEmail" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">نوع الحساب</label>
            <select id="editRole" class="form-select">
              <option>متبرع</option>
              <option>محتاج</option>
              <option>أدمن</option>
            </select>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-primary" id="saveEdit">حفظ التعديلات</button>
      </div>
    </div>
  </div>
</div>


<!-- Preview Modal -->
<!-- Modal -->
<div id="storyPreviewModal" class="story-preview-modal">
    <div class="story-preview-box">

        <span class="story-close-btn" id="closePreviewModal">&times;</span>

        <h2 class="story-preview-title">معاينة القصة</h2>

        <div class="story-info">
            <p><strong>العنوان:</strong> <span id="previewTitle"></span></p>
            <p><strong>النوع:</strong> <span id="previewType"></span></p>
            <p><strong>التصنيف:</strong> <span id="previewCategory"></span></p>
            <p><strong>الوقت:</strong> <span id="previewTime"></span></p>
            <p><strong>المحتوى:</strong></p>
            <p id="previewContent" style="white-space: pre-wrap;"></p>

            <p><strong>الكاتب:</strong> <span id="previewAuthor"></span></p>
            <p><strong>تاريخ الإنشاء:</strong> <span id="previewCreatedAt"></span></p>
            
            <p><strong>المبلغ المتبرع:</strong> <span id="previewDonations"></span></p>
            <p><strong>العملة:</strong> <span id="previewCurrency"></span></p>
            <p><strong>عدد المشاهدات:</strong> <span id="previewViews"></span></p>

            <img id="previewImage" style="width: 100%; margin-top: 15px; border-radius: 10px; display:none;" />
        </div>

    </div>
</div>





<script>



document.addEventListener("DOMContentLoaded", () => {
  fetchUsers();
});

function fetchUsers() {
  fetch("http://localhost:5000/api/admin/users", {
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`,
      },
    }) 
    .then(res => res.json())
    .then(data => {
      if (!data.success) return console.error("Failed loading users");

      const tableBody = document.querySelector("#usersTable tbody");
      tableBody.innerHTML = ""; // مسح الداتا القديمة

      data.users.forEach((user, index) => {
        // تحديد حالة الحساب
        const statusText =statusMap[user.status];

        // تحديد نوع الحساب حسب role
        const type =
          user.role === "admin"
            ? "أدمن"
            : user.role === "donor"
            ? "متبرع"
            : "محتاج";

        const row = `
          <tr>
            <td>${index + 1}</td>
            <td>${user.firstName} ${user.lastName}</td>
            <td>${user.email}</td>
            <td>${type}</td>
            <td>${statusText}</td>

            <td>
              <button class="action-btn edit" title="تعديل" onclick="openEditModal('${user._id}')"><i class="fa-solid fa-pen"></i></button>
              <button class="action-btn delete" onclick="deleteUser('${user._id}')" title="حذف"><i class="fa-solid fa-trash"></i></button>
              <button class="action-btn disable" onclick="toggleUserStatus(this,'${user._id}')" title="تعطيل"><i class="fa-solid fa-ban"></i></button>
            </td>
          </tr>
        `;

        tableBody.innerHTML += row;
      });
      initPagination();
    })
    .catch(err => console.error(err));

       
}

function deleteUser(userId) {

  Swal.fire({
    title: "هل أنتِ متأكدة؟",
    text: "سيتم حذف المستخدم نهائياً!",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "نعم، احذفه",
    cancelButtonText: "إلغاء",
    reverseButtons: true
  }).then(async (result) => {
    if (result.isConfirmed) {

      try {
        const res = await fetch(`http://localhost:5000/api/admin/users/${userId}`, {
          method: "DELETE" , 
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`,
      },
   
        });

        const data = await res.json();

        if (res.ok) {
          // حذف الصف من الواجهة
          const row = document.querySelector(`button[onclick="deleteUser('${userId}')"]`).closest("tr");
          row.remove();

          Swal.fire({
            title: "تم الحذف",
            text: "تم حذف المستخدم بنجاح",
            icon: "success",
            timer: 1500,
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            title: "خطأ",
            text: data.message || "لم يتم الحذف",
            icon: "error"
          });
        }

      } catch (err) {
        Swal.fire({
          title: "خطأ",
          text: "حدث خطأ أثناء تنفيذ العملية",
          icon: "error"
        });
      }
    }
  });

}

let currentEditUserId = null;

async function openEditModal(userId) {
  currentEditUserId = userId;

  // جلب بيانات المستخدم
  const res = await fetch(`http://localhost:5000/api/admin/users/${userId}`, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`
      },
    });
  const data = await res.json();

  if (!res.ok) {
    Swal.fire("خطأ", "لم يتم جلب بيانات المستخدم", "error");
    return;
  }

  // تعبئة الحقول في المودال
  document.getElementById("editName").value = data.firstName +" "+data.lastName || "";
  document.getElementById("editEmail").value = data.email || "";
  document.getElementById("editRole").value = translateRoleToArabic(data.role);

  // فتح المودال
  const modal = new bootstrap.Modal(document.getElementById("editModal"));
  modal.show();
}

document.getElementById("saveEdit").addEventListener("click", async () => {
  const name = document.getElementById("editName").value.trim();
  const [firstName, ...lastNameArr] = name.split(" ");
const lastName = lastNameArr.join(" ");
  const email = document.getElementById("editEmail").value.trim();
  const role = translateRoleToEnglish(document.getElementById("editRole").value);

  const body = { firstName,lastName, email: email, role: role };

  const res = await fetch(`http://localhost:5000/api/admin/users/${currentEditUserId}`,{
    method: "PUT",
    headers: { "Content-Type": "application/json" , 
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`
      },
    
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if (res.ok) {
    Swal.fire({
      icon: "success",
      title: "تم التعديل بنجاح",
      timer: 1500,
      showConfirmButton: false
    });

    // تحديث الصف في الجدول بدون ريفرش
    updateTableRow(currentEditUserId, name, email, document.getElementById("editRole").value);

    // إغلاق المودال
    bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();

  } else {
    Swal.fire("خطأ", data.message || "لم يتم حفظ التعديلات", "error");
  }
});

function updateTableRow(id, name, email, role) {
  const row = document.querySelector(`button[onclick="openEditModal('${id}')"]`).closest("tr");

  row.children[1].textContent = name;
  row.children[2].textContent = email;
  row.children[3].textContent = role;
}


// تحويل نوع الحساب عربـي ← انجليزي لإعادة الإرسال
function translateRoleToEnglish(role) {
  return role === "متبرع" ? "donor" :
         role === "محتاج" ? "needy" :
         "admin";
}

// تحويل من انجليزي ← عربي لتعبئة المودال
function translateRoleToArabic(role) {
  return role === "donor" ? "متبرع" :
         role === "needy" ? "محتاج" :
         "أدمن";
}
const statusMap = {
  active: "مفعل",
  inactive: "غير مفعل"
};
async function toggleUserStatus(btn, userId) {
  

  Swal.fire({
    title: 'هل أنت متأكد؟',
    text: "سيتم تغيير حالة المستخدم!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'نعم',
    cancelButtonText: 'إلغاء'
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        const res = await fetch(`http://localhost:5000/api/admin/users/${userId}/status`, {
          method: "PUT", 
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`,
      },
    });
       
        const data = await res.json();

        if (!res.ok) throw new Error(data.message || "حدث خطأ");

        Swal.fire({
          title: 'تم!',
          text: `تم تحديث حالة المستخدم: ${statusMap[data.status]}`,
          icon: 'success',
          timer: 1500,
          showConfirmButton: false
        });

        // تحديث النص في الجدول
        const row = btn.closest("tr");
        const statusCell = row.querySelector("td:nth-child(5)");
        statusCell.textContent =statusMap[data.status] || data.status;

      } catch (err) {
        Swal.fire({
          title: 'خطأ',
          text: err.message,
          icon: 'error'
        });
      }
    }
  });
}




    const searchInput = document.getElementById("searchInput");
    const roleFilter = document.getElementById("roleFilter");
    const table = document.getElementById("usersTable").getElementsByTagName("tbody")[0];

    function filterTable() {
      const searchText = searchInput.value.toLowerCase();
      const selectedRole = roleFilter.value;

      for (let row of table.rows) {
        const name = row.cells[1].textContent.toLowerCase();
        const email = row.cells[2].textContent.toLowerCase();
        const role = row.cells[3].textContent;

        const matchesSearch = name.includes(searchText) || email.includes(searchText);
        const matchesRole = selectedRole === "" || role === selectedRole;

        if (matchesSearch && matchesRole) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      }
    }

    searchInput.addEventListener("keyup", filterTable);
    roleFilter.addEventListener("change", filterTable);


    //تجزئة الجدول
function initPagination() {
 const rowsPerPage = 10;
  const mytable = document.getElementById("usersTable");
  const tbody = mytable.querySelector("tbody");
  const rows = tbody.getElementsByTagName("tr");
  const pagination = document.getElementById("pagination");

  let currentPage = 1;

  function displayRows(page) {
    let start = (page - 1) * rowsPerPage;
    let end = start + rowsPerPage;

    for (let i = 0; i < rows.length; i++) {
      rows[i].style.display = (i >= start && i < end) ? "" : "none";
    }
  }

  function setupPagination() {
    pagination.innerHTML = "";
    let pageCount = Math.ceil(rows.length / rowsPerPage);

    // زر السابق
    let prev = document.createElement("button");
    prev.innerHTML = "⟨";
    prev.disabled = currentPage === 1;
    prev.addEventListener("click", function () {
      if (currentPage > 1) {
        currentPage--;
        displayRows(currentPage);
        setupPagination();
      }
    });
    pagination.appendChild(prev);

    // الأزرار
    for (let i = 1; i <= pageCount; i++) {
      let btn = document.createElement("button");
      btn.innerText = i;

      if (i === currentPage) {
        btn.classList.add("active");
      }

      btn.addEventListener("click", function () {
        currentPage = i;
        displayRows(currentPage);
        setupPagination();
      });

      pagination.appendChild(btn);
    }

    // زر التالي
    let next = document.createElement("button");
    next.innerHTML = "⟩";
    next.disabled = currentPage === pageCount;
    next.addEventListener("click", function () {
      if (currentPage < pageCount) {
        currentPage++;
        displayRows(currentPage);
        setupPagination();
      }
    });
    pagination.appendChild(next);
  }

  displayRows(currentPage);
  setupPagination();
 
}





</script>

       <script src="admin.js"></script>
        <script src="headerAdmin.js"></script>


</body>
</html>