<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>
   <!--bootstrap-->
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--fontawsom-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&family=Tajawal:wght@500;700&display=swap" rel="stylesheet">
   <!--css-->
    <link rel="stylesheet" href="admin.css" />
    <style>
     table{
        border-radius: 5px;
        overflow: hidden;
       
    }
    .data-table th {
      background-color: #34495e;
      color: white;
    }
    

    </style>
    </head>
    <body>
     
       <!-- Sidebar -->
        
      <div class="sidebar">
        <div class="title">
          <h1><span>لوحة التحكم</span></h1>
        </div>
       <ul>
         <li>
            <a href="admin.html">
            <i class="fa-solid fa-house"></i>
            <span>الصفحة الرئيسية</span>
            </a>
          </li>
          <li>
            <a href="orderManagement.html">
            <i class="fa-solid fa-list-check"></i>
            <span>إدارة الطلبات</span>
          </a>
          </li>
          <li>
            <a href="donations.html">
            <i class="fa-solid fa-dollar-sign"></i>
            <span>التبرعات</span>
            </a>
          </li>
          <li>
            <a href="users.html">
            <i class="fa-solid fa-users"></i>
            <span>المستخدمون</span>
            </a>
          </li>

          
          <li>
            <a href="reports.html">
            <i class="fas fa-chart-line"></i>
            <span>التقارير</span>
            </a>
          </li>
         

          
          <li>
            <a href="settings.html">
            <i class="fas fa-cog"></i>
            <span>الإعدادات</span>
            </a>
          </li>
          

          <li>
            <a href="HomePage.html">
           <i class="fa-solid fa-arrow-up-right-from-square"></i>
            <span>زيارة الموقع</span>
            </a>
          </li>
          
        <li class="log-out " id="logoutBtn">
            <a href="#">
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
            <span>تسجيل الخروج</span>
            </a>
          </li>
        </div>
      </div>
       <!--end Sidebar--> 

       <div class="page">

        <!-- Header -->
       <div class="header">
        <div class="header-info">
        <div>
           مرحبا بك، <span id="header-welcome-name">محمد</span>! 
        </div>
        <div class="header-actions">
         <!-- أيقونة الجرس -->
    <div class="notification-dropdown">
          <div class="notification" id="notification">
            <i class="fa-solid fa-bell" id="storyBell"></i>
               <span class="badge" id="storyCount">0</span>
                 </div>
                 
     <ul class="menu" id="pendingList">
      
      <li> لا توجد إشعارات</li>
      
     </ul>
     
</div>
         
          <div class="user-profile">
            <div class="profile-img">
              <img src="" alt="profile-img"  id="header-profile-pic">
            </div>
            <div class="user-info">
              <div class="user-name"  id="header-user-name"> </div>
              <div class="user-role">مدير النظام</div>
            </div>
          </div>
        </div>
        </div>
        </div>
       <!--end header-->

       <div class="content">
        <div class="page-title">
          <div class="text">التبرعات</div>
         
        </div>
       

        <div class="d-flex  justify-content-between mb-3">
        <input type="text" class="form-control w-50" id="searchInput" placeholder="ابحث عن التبرع...">

        <div class="d-flex gap-1">
        
         <input type="date"  class="form-control startdate ">
        _
         <input type="date"  class="form-control  enddate">

         <button class="btn btn-outline-secondary" id="filterBtn">تصفية</button>
        </div>
        
      </div>

      <!-- جدول التبرعات -->
      <div class="table-responsive">
        <table class="data-table bg-white" id="donationsTable">
          <thead >
            <tr>
              <th>رقم</th>
              <th>اسم المتبرع</th>
              <th>المشروع</th>
              <th>المبلغ</th>
              <th>وسيلة الدفع</th>
              <th>التاريخ</th>
              <th>الحالة</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="donationsBody">
            <tr>
              <td>1</td>
              <td>أحمد محمد</td>
              <td>بناء مدرسة</td>
              <td>1000</td>
              <td>بطاقة</td>
              <td>10-03-2024</td>
              <td class="status-complete">مكتمل</td>
              <td>
                  <button class="btn  btn-sm btn-outline-primary border-2 btn-style btn-transform">
                    <i class="fas fa-eye"></i> 
                  </button>
                  <button class="btn  btn-sm btn-outline-success border-2 btn-style btn-transform">
                  <i class="fa-solid fa-check"></i>
                  </button>
                   <button class="btn  btn-sm btn-outline-danger border-2 btn-style btn-transform" >
                  <i class="fa-solid fa-xmark"></i>
                  </button>
                </td>
            </tr>
            <tr>
              <td>2</td>
              <td>خالد علي</td>
              <td>مركز صحي</td>
              <td>500</td>
              <td>تحويل بنكي</td>
              <td>09-03-2025</td>
              <td class="status-pending">قيد المراجعة</td>
            <td>
                  <button class="btn  btn-sm btn-outline-primary border-2 btn-style btn-transform">
                    <i class="fas fa-eye"></i> 
                  </button>
                  <button class="btn  btn-sm btn-outline-success border-2 btn-style btn-transform">
                  <i class="fa-solid fa-check"></i>
                  </button>
                   <button class="btn  btn-sm btn-outline-danger border-2 btn-style btn-transform">
                  <i class="fa-solid fa-xmark"></i>
                  </button>
                </td>
            </tr>
            <tr>
              <td>3</td>
              <td>سارة عيد</td>
              <td>إغاثة عاجلة</td>
              <td>250</td>
              <td>نقدي</td>
              <td>09-03-2024</td>
              <td class="status-rejected">مرفوض</td>
              <td>
                  <button class="btn  btn-sm btn-outline-primary border-2 btn-style btn-transform">
                    <i class="fas fa-eye"></i> 
                  </button>
                  <button class="btn  btn-sm btn-outline-success border-2 btn-style btn-transform">
                  <i class="fa-solid fa-check"></i>
                  </button>
                   <button class="btn  btn-sm btn-outline-danger border-2 btn-style btn-transform"   >
                  <i class="fa-solid fa-xmark"></i>
                  </button>
                </td>
            </tr>
          </tbody>
        </table>
      </div>
<div id="pagination" class="pagination justify-content-center"></div>

    </div>
  </div>

<!-- Modal رفض التبرع -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="direction: rtl; text-align: right">

      <div class="modal-header">
        <h5 class="modal-title">رفض التبرع</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label class="form-label">سبب الرفض:</label>
        <textarea id="rejectReason" class="form-control" rows="3" placeholder="أدخل سبب الرفض"></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button class="btn btn-danger" onclick="submitRejectReason()">رفض التبرع</button>
      </div>

    </div>
  </div>
</div>

<!-- مودال عرض التفاصيل -->
<div class="modal fade" id="donationDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-between">
        <div>
        <h5 class="modal-title">تفاصيل التبرع</h5></div>
        <div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
    </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="fw-bold">اسم المتبرع:</label>
            <span id="detail-donorName"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">البريد الإلكتروني:</label>
            <span id="detail-donorEmail"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">رقم الهاتف:</label>
            <span id="detail-donorPhone"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">رقم الهوية:</label>
            <span id="detail-donorIdCard"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">المشروع/الحالة:</label>
            <span id="detail-projectTitle"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">المبلغ:</label>
            <span id="detail-amount"></span>
          </div>
          
          <div class="col-md-6">
            <label class="fw-bold">وسيلة الدفع:</label>
            <span id="detail-paymentMethod"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">الحالة:</label>
            <span id="detail-status"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">معرف المعاملة:</label>
            <span id="detail-transactionId"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">تاريخ التبرع:</label>
            <span id="detail-donationDate"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">تاريخ الإنشاء:</label>
            <span id="detail-createdAt"></span>
          </div>
          <div class="col-md-6">
            <label class="fw-bold">تمت الإضافة بواسطة:</label>
            <span id="detail-authorName"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
      </div>
    </div>
  </div>
</div>


<!-- Preview Modal -->
<!-- Modal -->
<div id="storyPreviewModal" class="story-preview-modal">
    <div class="story-preview-box">

        <span class="story-close-btn" id="closePreviewModal">&times;</span>

        <h2 class="story-preview-title">معاينة القصة</h2>

        <div class="story-info">
            <p><strong>العنوان:</strong> <span id="previewTitle"></span></p>
            <p><strong>النوع:</strong> <span id="previewType"></span></p>
            <p><strong>التصنيف:</strong> <span id="previewCategory"></span></p>
            <p><strong>الوقت:</strong> <span id="previewTime"></span></p>
            <p><strong>المحتوى:</strong></p>
            <p id="previewContent" style="white-space: pre-wrap;"></p>

            <p><strong>الكاتب:</strong> <span id="previewAuthor"></span></p>
            <p><strong>تاريخ الإنشاء:</strong> <span id="previewCreatedAt"></span></p>
            
            <p><strong>المبلغ المتبرع:</strong> <span id="previewDonations"></span></p>
            <p><strong>العملة:</strong> <span id="previewCurrency"></span></p>
            <p><strong>عدد المشاهدات:</strong> <span id="previewViews"></span></p>

            <img id="previewImage" style="width: 100%; margin-top: 15px; border-radius: 10px; display:none;" />
        </div>

    </div>
</div>

<script>
//البحث
const searchInput = document.getElementById("searchInput");
   
    const table = document.getElementById("donationsTable").getElementsByTagName("tbody")[0];

    function filterTable() {
      const searchText = searchInput.value.toLowerCase();
     

      for (let row of table.rows) {
        const name = row.cells[1].textContent.toLowerCase();
        const project = row.cells[2].textContent.toLowerCase();

        const matchesSearch = name.includes(searchText) || project.includes(searchText);

        if (matchesSearch ) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      }
    }

    searchInput.addEventListener("keyup", filterTable);
  
const fromDateInput = document.querySelectorAll("input[type='date']")[0];
  const toDateInput = document.querySelectorAll("input[type='date']")[1];
  const filterBtn = document.getElementById("filterBtn");

// فلترة التاريخ عند الضغط على زر "تصفية"
  filterBtn.addEventListener("click", function () {
    const fromDate = fromDateInput.value;
    const toDate = toDateInput.value;
  const rowTable= document.querySelectorAll("#donationsTable tbody tr");

    rowTable.forEach((row) => {
      const dateText = row.querySelector("td:nth-child(6)").innerText.trim();
      const rowDate = new Date(dateText);

      let show = true;

      if (fromDate && rowDate < new Date(fromDate)) show = false;
      if (toDate && rowDate > new Date(toDate)) show = false;

     
    
      row.style.display = show ? "" : "none";
    });
  });




 

  document.addEventListener('DOMContentLoaded', () => {
 fetchDonations();
});


async function fetchDonations() {
  try {
    const res = await fetch("http://localhost:5000/api/admin/donations", {
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`,
      },
    });
    const data = await res.json();

    const tbody = document.getElementById("donationsBody");
    tbody.innerHTML = ""; // ننظف الجدول قبل التعبئة

    data.forEach(donation => {
      const row = document.createElement("tr");

      // تحديد اللون حسب الحالة
      let statusClass = "";
      switch(donation.status) {
        case 'completed': statusClass = "status-complete"; break;
        case 'pending': statusClass = "status-pending"; break;
        case 'failed': statusClass = "status-rejected"; break;
        default: statusClass = ""; break;
      }

      row.innerHTML = `
        <td>${donation.number}</td>
        <td>${donation.donorName}</td>
        <td>${donation.projectTitle}</td>
        <td>${donation.amount} ${donation.currency}</td>
        <td>${translatePaymentMethod(donation.paymentMethod)}</td>
        <td>${donation.date}</td>
        <td class="${statusClass}">${translateStatus(donation.status)}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary border-2 btn-style btn-transform" onclick="openDonationDetailsModal('${donation.id}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-success border-2 btn-style btn-transform" onclick="approveDonation('${donation.id}')">
            <i class="fa-solid fa-check"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger border-2 btn-style btn-transform" onclick="rejectDonation('${donation.id}')">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
initPagination();
  } catch (err) {
    console.error("حدث خطأ أثناء جلب التبرعات:", err);
    alert("فشل تحميل التبرعات");
  }
}


function translateStatus(status) {
  switch(status) {
    case 'pending': 
      return 'قيد المراجعة';
    case 'completed': 
      return 'مكتمل';
    case 'failed': 
      return 'مرفوض';
    default: 
      return status; // لو القيمة غير معروفة نرجعها كما هي
  }
}

function translatePaymentMethod(method) {
  switch(method) {
    case 'card': 
      return 'بطاقة';
    case 'paypal': 
      return 'باي بال';
    case 'wallet': 
      return 'محفظة إلكترونية';
    case 'transfer': 
      return 'تحويل بنكي';
    default: 
      return 'غير محدد'; 
  }
}


async function rejectDonation(donationId) {
  try {
    const result = await Swal.fire({
      title: 'هل أنت متأكد؟',
      text: "سيتم رفض هذا التبرع!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'نعم، رفض التبرع',
      cancelButtonText: 'إلغاء'
    });

    if (!result.isConfirmed) return;

    const res = await fetch(`http://localhost:5000/api/admin/donations/${donationId}/reject`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' , 
      Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`
      },
    
      body: JSON.stringify({}) // لا سبب، السيرفر يضع الملاحظة الافتراضية
    });

    const data = await res.json();

    if (res.ok) {
      Swal.fire({
        icon: 'success',
        title: 'تم الرفض',
        text: data.message
      }).then(() => {
        location.reload();
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'خطأ',
        text: data.message || 'حدث خطأ'
      });
    }

  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'خطأ',
      text: 'حدث خطأ أثناء رفض التبرع'
    });
  }
}

async function approveDonation(donationId) {
  try {
    const result = await Swal.fire({
      title: 'هل أنت متأكد؟',
      text: "سيتم اعتماد هذا التبرع!",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'نعم، اعتماد التبرع',
      cancelButtonText: 'إلغاء'
    });

    if (!result.isConfirmed) return;

    const res = await fetch(`http://localhost:5000/api/admin/donations/${donationId}/approve`, {
      method: 'PUT', 
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`
      },
    });
    

    const data = await res.json();

    if (res.ok) {
      Swal.fire({
        icon: 'success',
        title: 'تم الاعتماد',
        text: data.message
      }).then(() => {
        location.reload();
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'خطأ',
        text: data.message || 'حدث خطأ'
      });
    }

  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'خطأ',
      text: 'حدث خطأ أثناء اعتماد التبرع'
    });
  }
}

async function openDonationDetailsModal(donationId) {
  try {
    const res = await fetch(`http://localhost:5000/api/admin/donations/${donationId}`, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem("token")|| sessionStorage.getItem('token')}`
      },
    });
    const data = await res.json();

    if (!data.success) {
      Swal.fire('خطأ', 'تعذر جلب تفاصيل التبرع', 'error');
      return;
    }

    const donation = data.donation;

    // تعبئة الحقول
    document.getElementById('detail-donorName').textContent = donation.donorName;
    document.getElementById('detail-donorEmail').textContent = donation.donorEmail;
    document.getElementById('detail-donorPhone').textContent = donation.donorPhone;
    document.getElementById('detail-donorIdCard').textContent = donation.donorIdCard;
    document.getElementById('detail-projectTitle').textContent = donation.projectTitle;
    document.getElementById('detail-amount').textContent = donation.amount + ' ' + donation.currency;
    document.getElementById('detail-paymentMethod').textContent = translatePaymentMethod(donation.paymentMethod);
    document.getElementById('detail-status').textContent = translateStatus(donation.status);
    document.getElementById('detail-transactionId').textContent = donation.transactionId;
    document.getElementById('detail-donationDate').textContent = donation.donationDate;
    document.getElementById('detail-createdAt').textContent = donation.createdAt;
    document.getElementById('detail-authorName').textContent = donation.authorName;

    // عرض المودال
    const modalEl = document.getElementById('donationDetailsModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  } catch (err) {
    console.error(err);
    Swal.fire('خطأ', 'حدث خطأ أثناء فتح تفاصيل التبرع', 'error');
  }
}



    //تجزئة الجدول
function initPagination() {
 const rowsPerPage = 10;
  const mytable = document.getElementById("donationsTable");
  const tbody = mytable.querySelector("tbody");
  const rows = tbody.getElementsByTagName("tr");
  const pagination = document.getElementById("pagination");

  let currentPage = 1;

  function displayRows(page) {
    let start = (page - 1) * rowsPerPage;
    let end = start + rowsPerPage;

    for (let i = 0; i < rows.length; i++) {
      rows[i].style.display = (i >= start && i < end) ? "" : "none";
    }
  }

  function setupPagination() {
    pagination.innerHTML = "";
    let pageCount = Math.ceil(rows.length / rowsPerPage);

    // زر السابق
    let prev = document.createElement("button");
    prev.innerHTML = "⟨";
    prev.disabled = currentPage === 1;
    prev.addEventListener("click", function () {
      if (currentPage > 1) {
        currentPage--;
        displayRows(currentPage);
        setupPagination();
      }
    });
    pagination.appendChild(prev);

    // الأزرار
    for (let i = 1; i <= pageCount; i++) {
      let btn = document.createElement("button");
      btn.innerText = i;

      if (i === currentPage) {
        btn.classList.add("active");
      }

      btn.addEventListener("click", function () {
        currentPage = i;
        displayRows(currentPage);
        setupPagination();
      });

      pagination.appendChild(btn);
    }

    // زر التالي
    let next = document.createElement("button");
    next.innerHTML = "⟩";
    next.disabled = currentPage === pageCount;
    next.addEventListener("click", function () {
      if (currentPage < pageCount) {
        currentPage++;
        displayRows(currentPage);
        setupPagination();
      }
    });
    pagination.appendChild(next);
  }

  displayRows(currentPage);
  setupPagination();
 
}

</script>

     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="admin.js"></script>
      <script src="headerAdmin.js"></script>



</body>
</html>
